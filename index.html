<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control Profesional de Bodas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- =========================
       AJUSTES M√ìVIL ANDROID
       ========================= -->
  <style>
    @media (max-width: 576px){
      body { font-size: 0.95rem; }

      .btn { padding: .65rem .9rem; }

      .form-control, .form-select { font-size: 0.95rem; }

      .nav-tabs .nav-link{
        padding: .6rem .7rem;
        font-size: .9rem;
      }

      .table { font-size: 0.9rem; }
      .table th, .table td { white-space: nowrap; }

      /* Bot√≥n Guardar fijo abajo */
      .sticky-save{
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: .75rem;
        border-top: 1px solid #dee2e6;
        z-index: 10;
      }
    }
  </style>
</head>

<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <span class="navbar-brand fw-semibold">Control Profesional de Bodas</span>
    <span class="text-white-50 small">Multi-eventos ¬∑ Presupuesto ¬∑ Pagos ¬∑ Cronograma ¬∑ Reporte mensual</span>
  </div>
</nav>

<main class="container my-4">
  <!-- Dashboard mensual -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 align-items-end justify-content-between">
        <div>
          <h6 class="mb-1">Reporte mensual</h6>
          <div class="text-muted small">Seleccion√° un mes para ver cu√°ntos eventos hiciste y el resumen financiero.</div>
        </div>
        <div class="d-flex gap-2 align-items-end">
          <div>
            <label class="form-label mb-1">Mes</label>
            <input id="monthPick" type="month" class="form-control">
          </div>
          <div class="d-flex gap-2">
            <button id="btnExport" class="btn btn-outline-primary">Exportar JSON</button>
            <label class="btn btn-outline-secondary mb-0">
              Importar JSON <input id="fileImport" type="file" accept="application/json" hidden>
            </label>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-md-3">
          <div class="p-3 bg-white border rounded">
            <div class="text-muted small">Eventos del mes</div>
            <div class="fs-4 fw-bold" id="mEvents">0</div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="p-3 bg-white border rounded">
            <div class="text-muted small">Presupuesto total</div>
            <div class="fs-4 fw-bold" id="mBudget">‚Ç°0</div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="p-3 bg-white border rounded">
            <div class="text-muted small">Pagado total</div>
            <div class="fs-4 fw-bold" id="mPaid">‚Ç°0</div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="p-3 bg-white border rounded">
            <div class="text-muted small">Pendiente total</div>
            <div class="fs-4 fw-bold" id="mPending">‚Ç°0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gesti√≥n de eventos -->
  <div class="row g-3">
    <!-- ‚úÖ ORDEN PRO EN M√ìVIL: Eventos arriba -->
    <div class="col-12 col-lg-4 order-1 order-lg-0">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Eventos</h6>
            <span class="badge text-bg-secondary" id="eventsCount">0</span>
          </div>
          <div class="text-muted small mt-1">Cre√° y seleccion√° una boda para editar presupuesto, pagos y cronograma.</div>

          <div class="mt-3">
            <label class="form-label">Nuevo evento</label>
            <input id="newName" class="form-control mb-2" placeholder="Boda de Ana & Luis">
            <div class="row g-2">
              <div class="col-6">
                <input id="newDate" type="date" class="form-control" title="Fecha del evento">
              </div>
              <div class="col-6">
                <input id="newGuests" type="number" min="0" class="form-control" value="100" title="Invitados">
              </div>
            </div>
            <div class="d-grid mt-2">
              <button id="btnCreate" class="btn btn-primary">Crear evento</button>
            </div>
          </div>

          <hr>

          <div class="mb-2">
            <label class="form-label">Buscar</label>
            <input id="searchEvents" class="form-control" placeholder="Escrib√≠ un nombre...">
          </div>

          <div class="list-group" id="eventsList" style="max-height: 360px; overflow:auto;"></div>

          <div class="d-grid mt-3">
            <button id="btnDeleteEvent" class="btn btn-outline-danger" disabled>Eliminar evento seleccionado</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor del evento -->
    <!-- ‚úÖ ORDEN PRO EN M√ìVIL: Editor abajo -->
    <div class="col-12 col-lg-8 order-2 order-lg-0">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div>
              <h5 class="mb-0" id="evTitle">Seleccion√° un evento</h5>
              <div class="text-muted small" id="evSubtitle"></div>
            </div>
            <div class="d-flex gap-2">
              <button id="btnDuplicate" class="btn btn-outline-secondary" disabled>Duplicar</button>

              <!-- ‚úÖ BOT√ìN GUARDAR ‚ÄúSTICKY‚Äù SOLO EN M√ìVIL -->
              <div class="sticky-save p-0 border-0 bg-transparent">
                <button id="btnSaveEvent" class="btn btn-success w-100" disabled>Guardar cambios</button>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-12 col-md-3">
              <label class="form-label">Fecha</label>
              <input id="evDate" type="date" class="form-control" disabled>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Invitados</label>
              <input id="evGuests" type="number" min="0" class="form-control" disabled>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">‚Ç° / persona</label>
              <input id="evCostPerGuest" type="number" min="0" class="form-control" disabled>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Contingencia %</label>
              <input id="evContPct" type="number" min="0" class="form-control" disabled>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-12 col-md-4">
              <div class="p-3 bg-white border rounded">
                <div class="text-muted small">Presupuesto evento</div>
                <div class="fs-4 fw-bold" id="kBudget">‚Ç°0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="p-3 bg-white border rounded">
                <div class="text-muted small">Pagado</div>
                <div class="fs-4 fw-bold" id="kPaid">‚Ç°0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="p-3 bg-white border rounded">
                <div class="text-muted small">Pendiente</div>
                <div class="fs-4 fw-bold" id="kPending">‚Ç°0</div>
              </div>
            </div>
          </div>

          <hr class="my-3">

          <!-- Tabs -->
          <ul class="nav nav-tabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tBudget" type="button">Rubros</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tPayments" type="button">Pagos</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tTimeline" type="button">D√≠a del evento</button></li>
          </ul>

          <div class="tab-content border border-top-0 p-3 rounded-bottom bg-white">
            <!-- Rubros -->
            <div class="tab-pane fade show active" id="tBudget">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <h6>Agregar / editar rubro</h6>
                  <input id="catId" class="form-control" hidden>
                  <label class="form-label">Rubro</label>
                  <input id="catName" class="form-control mb-2" placeholder="Sal√≥n / DJ / Foto / Decoraci√≥n...">
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label">Presupuesto</label>
                      <input id="catBudget" type="number" min="0" class="form-control" value="0">
                    </div>
                    <div class="col-6">
                      <label class="form-label">Real</label>
                      <input id="catActual" type="number" min="0" class="form-control" value="0">
                    </div>
                  </div>
                  <div class="d-grid mt-3">
                    <button id="btnCatSave" class="btn btn-success" disabled>Guardar rubro</button>
                  </div>
                  <div class="d-grid mt-2">
                    <button id="btnCatClear" class="btn btn-outline-secondary" disabled>Limpiar</button>
                  </div>
                </div>

                <div class="col-12 col-md-8">
                  <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0">Listado de rubros</h6>
                    <span class="badge text-bg-secondary" id="catsCount">0</span>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th>Rubro</th>
                          <th class="text-end">Presupuesto</th>
                          <th class="text-end">Real</th>
                          <th class="text-end">Dif</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="catsTable"></tbody>
                    </table>
                  </div>
                  <div class="alert alert-info small mb-0">Tip: click en ‚ÄúEditar‚Äù para modificar un rubro.</div>
                </div>
              </div>
            </div>

            <!-- Pagos -->
            <div class="tab-pane fade" id="tPayments">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <h6>Agregar / editar pago</h6>
                  <input id="payId" class="form-control" hidden>
                  <label class="form-label">Concepto</label>
                  <input id="payConcept" class="form-control mb-2" placeholder="Se√±al sal√≥n / Abono DJ / etc.">
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label">Fecha</label>
                      <input id="payDate" type="date" class="form-control">
                    </div>
                    <div class="col-6">
                      <label class="form-label">M√©todo</label>
                      <select id="payMethod" class="form-select">
                        <option>Sinpe</option>
                        <option>Transferencia</option>
                        <option>Efectivo</option>
                        <option>Tarjeta</option>
                      </select>
                    </div>
                  </div>
                  <label class="form-label mt-2">Monto</label>
                  <input id="payAmount" type="number" min="0" class="form-control" value="0">
                  <div class="d-grid mt-3">
                    <button id="btnPaySave" class="btn btn-success" disabled>Guardar pago</button>
                  </div>
                  <div class="d-grid mt-2">
                    <button id="btnPayClear" class="btn btn-outline-secondary" disabled>Limpiar</button>
                  </div>
                </div>

                <div class="col-12 col-md-8">
                  <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0">Pagos registrados</h6>
                    <span class="badge text-bg-secondary" id="paysCount">0</span>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th>Concepto</th>
                          <th>Fecha</th>
                          <th>M√©todo</th>
                          <th class="text-end">Monto</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="paysTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cronograma -->
            <div class="tab-pane fade" id="tTimeline">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <h6>Agregar / editar actividad</h6>
                  <input id="tlId" class="form-control" hidden>
                  <div class="row g-2">
                    <div class="col-5">
                      <label class="form-label">Hora</label>
                      <input id="tlTime" type="time" class="form-control">
                    </div>
                    <div class="col-7">
                      <label class="form-label">Responsable</label>
                      <input id="tlOwner" class="form-control" placeholder="Planner / DJ / Novios...">
                    </div>
                  </div>
                  <label class="form-label mt-2">Actividad</label>
                  <input id="tlTask" class="form-control" placeholder="Ceremonia / Entrada / Cena...">
                  <label class="form-label mt-2">Estado</label>
                  <select id="tlStatus" class="form-select">
                    <option>Pendiente</option>
                    <option>En progreso</option>
                    <option>Listo</option>
                  </select>
                  <div class="d-grid mt-3">
                    <button id="btnTlSave" class="btn btn-success" disabled>Guardar actividad</button>
                  </div>
                  <div class="d-grid mt-2">
                    <button id="btnTlClear" class="btn btn-outline-secondary" disabled>Limpiar</button>
                  </div>
                </div>

                <div class="col-12 col-md-8">
                  <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0">Cronograma</h6>
                    <span class="badge text-bg-secondary" id="tlsCount">0</span>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th>Hora</th>
                          <th>Actividad</th>
                          <th>Responsable</th>
                          <th>Estado</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="tlsTable"></tbody>
                    </table>
                  </div>
                  <div class="alert alert-warning small mb-0">Esto es para que el d√≠a del evento fluya sin fricci√≥n.</div>
                </div>
              </div>
            </div>

          </div><!-- tab content -->
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- üîΩ TU JS SE MANTIENE IGUAL (NO LO TOQU√â) -->
<script>
  const KEY = "wedding_pro_v1";
  const state = { events: [], selectedId: null };

  const fmtCRC = (n) => "‚Ç°" + (Number(n||0)).toLocaleString("es-CR");
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try { Object.assign(state, JSON.parse(raw)); } catch(e){}
  }

  function getSelected(){
    return state.events.find(e => e.id === state.selectedId) || null;
  }

  function calcEventTotals(ev){
    const guests = Number(ev.guests||0);
    const cpg = Number(ev.costPerGuest||0);
    const catering = guests * cpg;

    const catsBudget = (ev.categories||[]).reduce((a,c)=>a+Number(c.budget||0),0);
    const base = catering + catsBudget;

    const cont = base * (Number(ev.contingencyPct||0)/100);
    const budgetTotal = base + cont;

    const paid = (ev.payments||[]).reduce((a,p)=>a+Number(p.amount||0),0);
    const pending = Math.max(0, budgetTotal - paid);

    return { catering, catsBudget, cont, budgetTotal, paid, pending };
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderEventsList(){
    const q = document.getElementById("searchEvents").value.trim().toLowerCase();
    const list = document.getElementById("eventsList");
    list.innerHTML = "";

    const filtered = state.events
      .slice()
      .sort((a,b)=>(b.date||"").localeCompare(a.date||""))
      .filter(e => (e.name||"").toLowerCase().includes(q));

    filtered.forEach(ev=>{
      const active = ev.id === state.selectedId ? "active" : "";
      const totals = calcEventTotals(ev);
      const item = document.createElement("button");
      item.className = `list-group-item list-group-item-action ${active}`;
      item.innerHTML = `
        <div class="d-flex justify-content-between">
          <div>
            <div class="fw-semibold">${esc(ev.name||"Evento")}</div>
            <div class="small ${active ? "text-white-50":"text-muted"}">${ev.date||"sin fecha"} ¬∑ invitados: ${ev.guests||0}</div>
          </div>
          <div class="text-end">
            <div class="small ${active ? "text-white-50":"text-muted"}">Presupuesto</div>
            <div class="fw-semibold">${fmtCRC(totals.budgetTotal)}</div>
          </div>
        </div>
      `;
      item.onclick = ()=>{ state.selectedId = ev.id; save(); renderAll(); };
      list.appendChild(item);
    });

    document.getElementById("eventsCount").textContent = state.events.length;
  }

  function renderEditor(){
    const ev = getSelected();
    const disabled = !ev;

    document.getElementById("btnSaveEvent").disabled = disabled;
    document.getElementById("btnDuplicate").disabled = disabled;
    document.getElementById("btnDeleteEvent").disabled = disabled;

    const fields = ["evDate","evGuests","evCostPerGuest","evContPct"];
    fields.forEach(id=>document.getElementById(id).disabled = disabled);

    document.getElementById("btnCatSave").disabled = disabled;
    document.getElementById("btnCatClear").disabled = disabled;
    document.getElementById("btnPaySave").disabled = disabled;
    document.getElementById("btnPayClear").disabled = disabled;
    document.getElementById("btnTlSave").disabled = disabled;
    document.getElementById("btnTlClear").disabled = disabled;

    if(!ev){
      document.getElementById("evTitle").textContent = "Seleccion√° un evento";
      document.getElementById("evSubtitle").textContent = "";
      document.getElementById("kBudget").textContent = "‚Ç°0";
      document.getElementById("kPaid").textContent = "‚Ç°0";
      document.getElementById("kPending").textContent = "‚Ç°0";
      document.getElementById("catsTable").innerHTML = "";
      document.getElementById("paysTable").innerHTML = "";
      document.getElementById("tlsTable").innerHTML = "";
      document.getElementById("catsCount").textContent = "0";
      document.getElementById("paysCount").textContent = "0";
      document.getElementById("tlsCount").textContent = "0";
      return;
    }

    document.getElementById("evTitle").textContent = ev.name || "Evento";
    document.getElementById("evSubtitle").textContent = `${ev.date||"sin fecha"} ¬∑ invitados: ${ev.guests||0}`;

    document.getElementById("evDate").value = ev.date || "";
    document.getElementById("evGuests").value = ev.guests ?? 0;
    document.getElementById("evCostPerGuest").value = ev.costPerGuest ?? 0;
    document.getElementById("evContPct").value = ev.contingencyPct ?? 0;

    const totals = calcEventTotals(ev);
    document.getElementById("kBudget").textContent = fmtCRC(totals.budgetTotal);
    document.getElementById("kPaid").textContent = fmtCRC(totals.paid);
    document.getElementById("kPending").textContent = fmtCRC(totals.pending);

    const cats = ev.categories || [];
    document.getElementById("catsCount").textContent = cats.length;
    const ct = document.getElementById("catsTable");
    ct.innerHTML = "";
    cats.forEach(c=>{
      const diff = Number(c.budget||0)-Number(c.actual||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(c.name)}</td>
        <td class="text-end">${fmtCRC(c.budget)}</td>
        <td class="text-end">${fmtCRC(c.actual)}</td>
        <td class="text-end ${diff<0?'text-danger':'text-success'}">${fmtCRC(diff)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit-cat="${c.id}">Editar</button>
          <button class="btn btn-sm btn-outline-danger" data-del-cat="${c.id}">Eliminar</button>
        </td>
      `;
      ct.appendChild(tr);
    });

    const pays = ev.payments || [];
    document.getElementById("paysCount").textContent = pays.length;
    const pt = document.getElementById("paysTable");
    pt.innerHTML = "";
    pays.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(p.concept)}</td>
        <td>${p.date||""}</td>
        <td>${esc(p.method)}</td>
        <td class="text-end">${fmtCRC(p.amount)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit-pay="${p.id}">Editar</button>
          <button class="btn btn-sm btn-outline-danger" data-del-pay="${p.id}">Eliminar</button>
        </td>
      `;
      pt.appendChild(tr);
    });

    const tls = (ev.timeline||[]).slice().sort((a,b)=>(a.time||"").localeCompare(b.time||""));
    document.getElementById("tlsCount").textContent = tls.length;
    const tt = document.getElementById("tlsTable");
    tt.innerHTML = "";
    tls.forEach(t=>{
      const badge = t.status==="Listo"?"text-bg-success":t.status==="En progreso"?"text-bg-warning":"text-bg-secondary";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.time||""}</td>
        <td>${esc(t.task)}</td>
        <td>${esc(t.owner)}</td>
        <td><span class="badge ${badge}">${esc(t.status)}</span></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit-tl="${t.id}">Editar</button>
          <button class="btn btn-sm btn-outline-danger" data-del-tl="${t.id}">Eliminar</button>
        </td>
      `;
      tt.appendChild(tr);
    });
  }

  function renderMonthly(){
    const pick = document.getElementById("monthPick");
    const m = pick.value;
    if(!m){
      const now = new Date();
      pick.value = now.toISOString().slice(0,7);
    }
    const month = pick.value;

    const eventsInMonth = state.events.filter(e => (e.date||"").startsWith(month));
    const totals = eventsInMonth.reduce((acc, ev)=>{
      const t = calcEventTotals(ev);
      acc.budget += t.budgetTotal;
      acc.paid += t.paid;
      acc.pending += t.pending;
      return acc;
    }, {budget:0, paid:0, pending:0});

    document.getElementById("mEvents").textContent = eventsInMonth.length;
    document.getElementById("mBudget").textContent = fmtCRC(totals.budget);
    document.getElementById("mPaid").textContent = fmtCRC(totals.paid);
    document.getElementById("mPending").textContent = fmtCRC(totals.pending);
  }

  function renderAll(){
    renderEventsList();
    renderEditor();
    renderMonthly();
    save();
  }

  document.getElementById("btnCreate").addEventListener("click", ()=>{
    const name = document.getElementById("newName").value.trim();
    const date = document.getElementById("newDate").value;
    const guests = Number(document.getElementById("newGuests").value||0);

    if(!name) return alert("Pon√© un nombre para el evento.");
    const ev = {
      id: uid(),
      name,
      date,
      guests,
      costPerGuest: 18000,
      contingencyPct: 10,
      categories: [],
      payments: [],
      timeline: []
    };
    state.events.push(ev);
    state.selectedId = ev.id;

    document.getElementById("newName").value = "";
    document.getElementById("newDate").value = "";
    document.getElementById("newGuests").value = 100;

    clearCatForm(); clearPayForm(); clearTlForm();
    renderAll();
  });

  document.getElementById("searchEvents").addEventListener("input", renderEventsList);

  document.getElementById("btnSaveEvent").addEventListener("click", ()=>{
    const ev = getSelected(); if(!ev) return;
    ev.date = document.getElementById("evDate").value;
    ev.guests = Number(document.getElementById("evGuests").value||0);
    ev.costPerGuest = Number(document.getElementById("evCostPerGuest").value||0);
    ev.contingencyPct = Number(document.getElementById("evContPct").value||0);
    renderAll();
  });

  document.getElementById("btnDuplicate").addEventListener("click", ()=>{
    const ev = getSelected(); if(!ev) return;
    const copy = JSON.parse(JSON.stringify(ev));
    copy.id = uid();
    copy.name = (ev.name||"Evento") + " (copia)";
    state.events.push(copy);
    state.selectedId = copy.id;
    renderAll();
  });

  document.getElementById("btnDeleteEvent").addEventListener("click", ()=>{
    const ev = getSelected(); if(!ev) return;
    if(!confirm("¬øEliminar este evento?")) return;
    state.events = state.events.filter(x=>x.id!==ev.id);
    state.selectedId = state.events[0]?.id || null;
    clearCatForm(); clearPayForm(); clearTlForm();
    renderAll();
  });

  function clearCatForm(){
    document.getElementById("catId").value = "";
    document.getElementById("catName").value = "";
    document.getElementById("catBudget").value = 0;
    document.getElementById("catActual").value = 0;
  }
  document.getElementById("btnCatClear").addEventListener("click", clearCatForm);

  document.getElementById("btnCatSave").addEventListener("click", ()=>{
    const ev = getSelected(); if(!ev) return;
    const id = document.getElementById("catId").value;
    const name = document.getElementById("catName").value.trim();
    const budget = Number(document.getElementById("catBudget").value||0);
    const actual = Number(document.getElementById("catActual").value||0);
    if(!name) return;

    ev.categories = ev.categories || [];
    if(id){
      const row = ev.categories.find(x=>x.id===id);
      if(row){ row.name=name; row.budget=budget; row.actual=actual; }
    }else{
      ev.categories.push({id:uid(), name, budget, actual});
    }
    clearCatForm();
    renderAll();
  });

  function clearPayForm(){
    document.getElementById("payId").value = "";
    document.getElementById("payConcept").value = "";
    document.getElementById("payDate").value = "";
    document.getElementById("payMethod").value = "Sinpe";
    document.getElementById("payAmount").value = 0;
  }
  document.getElementById("btnPayClear").addEventListener("click", clearPayForm);

  document.getElementById("btnPaySave").addEventListener("click", ()=>{
    const ev = getSelected(); if(!ev) return;
    const id = document.getElementById("payId").value;
    const concept = document.getElementById("payConcept").value.trim();
    const date = document.getElementById("payDate").value;
    const method = document.getElementById("payMethod").value;
    const amount = Number(document.getElementById("payAmount").value||0);
    if(!concept || amount<=0) return;

    ev.payments = ev.payments || [];
    if(id){
      const row = ev.payments.find(x=>x.id===id);
      if(row){ row.concept=concept; row.date=date; row.method=method; row.amount=amount; }
    }else{
      ev.payments.push({id:uid(), concept, date, method, amount});
    }
    clearPayForm();
    renderAll();
  });

  function clearTlForm(){
    document.getElementById("tlId").value = "";
    document.getElementById("tlTime").value = "";
    document.getElementById("tlOwner").value = "";
    document.getElementById("tlTask").value = "";
    document.getElementById("tlStatus").value = "Pendiente";
  }
  document.getElementById("btnTlClear").addEventListener("click", clearTlForm);

  document.getElementById("btnTlSave").addEventListener("click", ()=>{
    const ev = getSelected(); if(!ev) return;
    const id = document.getElementById("tlId").value;
    const time = document.getElementById("tlTime").value;
    const owner = document.getElementById("tlOwner").value.trim();
    const task = document.getElementById("tlTask").value.trim();
    const status = document.getElementById("tlStatus").value;
    if(!time || !task) return;

    ev.timeline = ev.timeline || [];
    if(id){
      const row = ev.timeline.find(x=>x.id===id);
      if(row){ row.time=time; row.owner=owner; row.task=task; row.status=status; }
    }else{
      ev.timeline.push({id:uid(), time, owner, task, status});
    }
    clearTlForm();
    renderAll();
  });

  document.addEventListener("click", (e)=>{
    const ev = getSelected(); if(!ev) return;

    const editCat = e.target.getAttribute("data-edit-cat");
    const delCat  = e.target.getAttribute("data-del-cat");
    const editPay = e.target.getAttribute("data-edit-pay");
    const delPay  = e.target.getAttribute("data-del-pay");
    const editTl  = e.target.getAttribute("data-edit-tl");
    const delTl   = e.target.getAttribute("data-del-tl");

    if(editCat){
      const c = (ev.categories||[]).find(x=>x.id===editCat);
      if(!c) return;
      document.getElementById("catId").value = c.id;
      document.getElementById("catName").value = c.name;
      document.getElementById("catBudget").value = c.budget||0;
      document.getElementById("catActual").value = c.actual||0;
    }
    if(delCat){
      if(!confirm("¬øEliminar este rubro?")) return;
      ev.categories = (ev.categories||[]).filter(x=>x.id!==delCat);
      renderAll();
    }

    if(editPay){
      const p = (ev.payments||[]).find(x=>x.id===editPay);
      if(!p) return;
      document.getElementById("payId").value = p.id;
      document.getElementById("payConcept").value = p.concept;
      document.getElementById("payDate").value = p.date||"";
      document.getElementById("payMethod").value = p.method||"Sinpe";
      document.getElementById("payAmount").value = p.amount||0;
    }
    if(delPay){
      if(!confirm("¬øEliminar este pago?")) return;
      ev.payments = (ev.payments||[]).filter(x=>x.id!==delPay);
      renderAll();
    }

    if(editTl){
      const t = (ev.timeline||[]).find(x=>x.id===editTl);
      if(!t) return;
      document.getElementById("tlId").value = t.id;
      document.getElementById("tlTime").value = t.time||"";
      document.getElementById("tlOwner").value = t.owner||"";
      document.getElementById("tlTask").value = t.task||"";
      document.getElementById("tlStatus").value = t.status||"Pendiente";
    }
    if(delTl){
      if(!confirm("¬øEliminar esta actividad?")) return;
      ev.timeline = (ev.timeline||[]).filter(x=>x.id!==delTl);
      renderAll();
    }
  });

  document.getElementById("monthPick").addEventListener("change", renderMonthly);

  document.getElementById("btnExport").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "control-bodas-backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("fileImport").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      if(!data || !Array.isArray(data.events)) throw new Error("Formato inv√°lido");
      state.events = data.events;
      state.selectedId = data.selectedId || state.events[0]?.id || null;
      save();
      clearCatForm(); clearPayForm(); clearTlForm();
      renderAll();
      alert("Importado correctamente.");
    }catch(err){
      alert("No se pudo importar. Asegurate de subir un JSON de respaldo v√°lido.");
    }finally{
      e.target.value = "";
    }
  });

  function setCrudEnabled(){
    const has = !!getSelected();
    ["btnCatSave","btnCatClear","btnPaySave","btnPayClear","btnTlSave","btnTlClear"].forEach(id=>{
      document.getElementById(id).disabled = !has;
    });
  }

  load();
  const now = new Date();
  document.getElementById("monthPick").value = now.toISOString().slice(0,7);

  if(!state.selectedId && state.events[0]) state.selectedId = state.events[0].id;

  const _renderAll = renderAll;
  renderAll = function(){ _renderAll(); setCrudEnabled(); };
  renderAll();
</script>
</body>
</html>
